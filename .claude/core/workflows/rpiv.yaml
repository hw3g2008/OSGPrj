# ============================================
# RPIV 工作流定义
# Research → Plan → Implement → Validate
# ============================================

name: RPIV
description: "一人公司 AI 开发工作流"

# 阶段定义
phases:
  # R - Research 研究阶段
  research:
    name: "研究"
    agent: architect
    skills:
      - brainstorming
      - memory-bank
    commands:
      - /brainstorm
    output:
      - 需求规格文档
      - 技术决策
    next: plan
    approval: false  # 无需审批，自动进入下一阶段
  
  # P - Plan 规划阶段
  plan:
    name: "规划"
    agent: planner
    skills:
      - story-splitter
      - ticket-splitter
    commands:
      - /split story
      - /split ticket
    output:
      - Stories 列表
      - Tickets 列表
    approval_points:
      - story_split: "/approve stories"
      - ticket_split: "/approve tickets"
    next: implement
  
  # I - Implement 实现阶段
  implement:
    name: "实现"
    agent: developer
    skills:
      - deliver-ticket
      - tdd
      - debugging
      - checkpoint-manager
    commands:
      - /next
    output:
      - 代码变更
      - 测试
    approval_points:
      - ticket_done: "config.approval.ticket_done"
    next: validate
  
  # V - Validate 验证阶段
  validate:
    name: "验证"
    agents:
      - reviewer
      - qa
    skills:
      - code-review
      - verification
    commands:
      - /review
      - /verify
    output:
      - 审查报告
      - 验证报告
    approval_points:
      - story_done: "/approve S-xxx"
    next: complete

# 状态转换
transitions:
  not_started → brainstorming:
    trigger: "/brainstorm"
    
  brainstorming → story_split:
    trigger: "需求分析完成"
    auto: true
    
  story_split → story_approved:
    trigger: "/approve stories"
    
  story_approved → ticket_split:
    trigger: "/split ticket"
    
  ticket_split → ticket_approved:
    trigger: "/approve tickets"
    
  ticket_approved → implementing:
    trigger: "/next"
    
  implementing → implementing:
    trigger: "Ticket 完成，还有 pending"
    condition: "config.approval.ticket_done == 'auto'"
    
  implementing → completed:
    trigger: "所有 Tickets 完成"

# 回滚规则
rollback:
  - from: implementing
    to: ticket_approved
    trigger: "/rollback"
    condition: "测试持续失败"
    
  - from: ticket_split
    to: story_approved
    trigger: "/rollback"
    condition: "Ticket 拆分有问题"
