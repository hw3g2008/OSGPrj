# ============================================
# RPIV 工作流状态机定义
# 单一来源 - 所有状态转换逻辑从此文件读取
# ============================================

name: RPIV
description: "一人公司 AI 开发工作流 (Research → Plan → Implement → Validate)"

# ============================================
# 术语说明
# ============================================
# - 状态 (state)：工作流当前所处的位置，用 _done/_approved 后缀
# - 动作 (action)：下一步要执行的操作，用动词形式
# - current_step：STATE.yaml 中存储的当前状态
# - next_step：STATE.yaml 中存储的下一个动作

# ============================================
# 状态定义
# key = 状态名，next_action = 下一个动作
# ============================================
states:
  # --- 初始状态 ---
  not_started:
    phase: init
    description: "项目已初始化，等待开始"
    next_action: brainstorm
    approval_required: false

  # --- Research 阶段 ---
  brainstorm_done:
    phase: research
    description: "需求分析完成"
    next_action: split_story
    approval_required: false

  brainstorm_pending_confirm:
    phase: research
    description: "需求分析完成但有待产品确认的疑问项"
    next_action: approve_brainstorm
    approval_required: true
    approval_key: brainstorm_confirm

  # --- Plan 阶段 ---
  story_split_done:
    phase: plan
    description: "Story 拆分完成"
    next_action: approve_stories
    approval_required: true
    approval_key: story_split

  stories_approved:
    phase: plan
    description: "Stories 审批通过"
    next_action: split_ticket
    approval_required: false

  ticket_split_done:
    phase: plan
    description: "Ticket 拆分完成"
    next_action: approve_tickets
    approval_required: true
    approval_key: ticket_split

  tickets_approved:
    phase: plan
    description: "Tickets 审批通过"
    next_action: next
    approval_required: false

  # --- Implement 阶段 ---
  implementing:
    phase: implement
    description: "正在实现 Tickets"
    next_action: next
    approval_required: false

  # 理论节点：正常流程中 deliver-ticket 经 transition() 推进到 implementing/story_verified，绕过此状态。唯一合法用途：回滚目标（规则 1）
  ticket_done:
    phase: implement
    description: "Ticket 执行完成"
    next_action: next
    approval_required: false
    approval_key: ticket_done  # 可配置为 required

  # 理论节点：正常流程中 deliver-ticket 经 transition() 调用 verify_story()，绕过此状态。唯一合法用途：回滚目标（规则 3/5）
  all_tickets_done:
    phase: implement
    description: "所有 Tickets 完成"
    next_action: verify
    approval_required: false

  # --- Validate 阶段 ---
  story_verified:
    phase: validate
    description: "Story 验收通过，等待用户选择 /cc-review 或 /approve"
    next_action: null  # 用户自行选择
    approval_required: false

  verification_failed:
    phase: validate
    description: "Story 验收失败，暂停等用户修复后重试 /verify"
    next_action: null  # 暂停等用户修复，不自动重试
    approval_required: false

  story_done:
    phase: validate
    description: "Story 验收完成"
    next_action: approve_story
    approval_required: true
    approval_key: story_done

  story_approved:
    phase: validate
    description: "Story 审批通过"
    next_action: next_story
    approval_required: false

  all_stories_done:
    phase: validate
    description: "所有 Stories 完成"
    next_action: null
    approval_required: false

# ============================================
# 命令到状态映射
# 命令完成后，工作流进入对应的状态
# ============================================
command_to_state:
  "/brainstorm": brainstorm_done  # 默认；brainstorming Skill 自己管理分支（done 或 pending_confirm）
  # "/approve brainstorm" 已移除：approve 流程自管理状态（phase0 同步调用 /brainstorm，phase4 直接写 STATE.yaml）
  "/split story": story_split_done
  "/split ticket": ticket_split_done
  "/approve stories": stories_approved
  "/approve tickets": tickets_approved
  "/next": implementing  # 默认；deliver-ticket 自己管理分支（implementing/story_verified/verification_failed）
  "/verify": story_verified  # 默认；verify_completion 分支处理 story_verified/verification_failed
  "/approve story": story_approved  # 或 all_stories_done（需判断是否还有 pending）

# ============================================
# 动作到命令映射
# 当 next_step 为某动作时，执行对应的命令
# ============================================
action_to_command:
  brainstorm: "/brainstorm"
  approve_brainstorm: "/approve brainstorm"
  split_story: "/split story"
  approve_stories: "/approve stories"
  split_ticket: "/split ticket {current_story}"
  approve_tickets: "/approve tickets"
  next: "/next"
  verify: "/verify {current_story}"
  approve_story: "/approve {current_story}"
  next_story: null  # 特殊处理：检查是否有下一个 Story

# ============================================
# 审批配置键映射
# 动作 → config.approval 中的键名
# ============================================
approval_config_keys:
  approve_brainstorm: brainstorm_confirm
  approve_stories: story_split
  approve_tickets: ticket_split
  approve_story: story_done
  next: ticket_done

# ============================================
# 特殊分支逻辑
# ============================================
special_branches:
  # /brainstorm 完成后的分支（brainstorming Skill 经 transition() 写 STATE.yaml）
  brainstorm_completion:
    note: "brainstorming Skill 完成后经 transition() 写 STATE.yaml"
    condition: "has_pending_decisions(module)"
    true_state: brainstorm_pending_confirm
    false_state: brainstorm_done

  # /next 完成后的分支（deliver-ticket 经 transition() 管理状态，此处作文档说明）
  next_completion:
    note: "deliver-ticket 完成后经 transition() 写 STATE.yaml"
    condition: "no_pending_tickets(current_story)"
    true_branch:
      condition: "verify_story_passed(current_story)"
      true_state: story_verified
      false_state: verification_failed
    false_state: implementing

  # /verify 手动重试后的分支
  verify_completion:
    condition: "verify_story_passed(current_story)"
    true_state: story_verified
    false_state: verification_failed

  # /approve story 完成后的分支
  approve_story_completion:
    condition: "no_pending_stories()"
    true_state: all_stories_done
    false_state: story_approved

  # next_story 动作的分支
  next_story:
    condition: "has_pending_stories()"
    true_action:
      - "current_story = next_pending_story()"
      - "current_step = stories_approved"
      - "next_step = split_ticket"
      - "execute /split ticket {current_story}"
    false_action:
      - "current_step = all_stories_done"
      - "next_step = null"
      - "output '所有 Stories 已完成'"

# ============================================
# 回滚规则
# ============================================
rollback:
  - from: [ticket_done, all_tickets_done]
    to: tickets_approved
    trigger: "/rollback"
    condition: "测试持续失败"

  - from: ticket_split_done
    to: stories_approved
    trigger: "/rollback"
    condition: "Ticket 拆分有问题"

  - from: story_done
    to: all_tickets_done
    trigger: "/rollback"
    condition: "验收失败"

  - from: [implementing]
    to: tickets_approved
    trigger: "/rollback"
    condition: "实现过程中发现 Ticket 拆分有问题"

  - from: [story_verified, verification_failed]
    to: all_tickets_done
    trigger: "/rollback"
    condition: "验收结果有问题，需要重新验收"

  - from: [brainstorm_pending_confirm]
    to: not_started
    trigger: "/rollback"
    condition: "需求分析需要重新开始"
