# implement-fix-plan v2 改造方案

> 定位：通用计划生成器 — 任何开发任务都要文档先行，本工作流帮助快速生成高质量方案文档。
> 目标：方案文档 max 3 轮用户交互即成型（成型 = 用户确认定稿；Phase 0 内部的自校验轮次不计入）。
> 设计原则：一看就懂、每个节点只做一件事、出口统一、上游有问题就停、最少概念、最短路径、改动自洽、简约不等于省略。

---

## 一、问题分析

### 当前流程的瓶颈

```
用户描述需求 → 生成方案 v1 → 用户反馈 → 改 v2 → 用户反馈 → 改 v3 → ...
                                                       ↑ 每次反馈都发现新问题
```

**根本原因**：
1. **方案生成时没有用最高标准** — 先出低质量方案，再逐步提升
2. **校验和生成分离** — 生成完了才校验，校验发现问题再改
3. **缺少结构化的分析模板** — 每次都从零开始思考，容易遗漏
4. **用户反馈驱动** — 依赖用户发现问题，而不是 AI 自己发现
5. **WS 不自动读取框架规则** — 导致 AI 不知道设计原则，生成质量不稳定

### 目标流程

```
用户描述需求
  ▼
第 1 轮：AI 执行 Phase 0 全部 5 步（读取→分析→生成→自校验→输出）→ 高质量方案文档
  ▼
第 2 轮：用户审阅 → 反馈 → AI 修正
  ▼
第 3 轮：用户确认 → 定稿 → 进入 Phase 1~6 按方案执行
```

---

## 二、改造核心：Phase 0 重构

### 当前 Phase 0（4 步）

```
0-1. 问题/需求分析
0-2. 影响范围评估
0-3. 生成方案
0-4. 用户确认
```

问题：步骤太粗，没有内置校验，没有强制读取规则。

### 新 Phase 0（5 步）

```
0-1. 读取上下文（迭代式）
     a. 读取 .claude/CLAUDE.md（设计原则 + 禁止行为）
     b. 根据需求关键词搜索直接相关文件，完整读取
     c. 从已读文件中发现引用的其他文件（import/引用/配置），继续读取
     d. 重复 c 直到没有新发现
     e. 读取 STATE.yaml（当前项目状态，如存在）
     f. 完整性检查 — 列出已读文件清单，确认覆盖了上游输入和下游消费者
     → 目标：让 AI 拥有与用户同等的上下文理解

0-2. 分析 + 设计决策
     a. 需求分析 — 明确要做什么、为什么做、做到什么程度
     b. 影响范围 — 列出所有受影响的文件/模块/流程 + 上下游依赖
     c. 设计决策 — 列出关键决策点 + 每个决策的选项 + 推荐方案 + 理由
     d. 前置条件/假设 — 显式列出所有隐含假设

0-3. 生成方案
     按模板生成完整方案文档（见第三节）
     注意：至少"目标"和"执行清单"必须有实质内容

0-4. 自校验 + 自修正（max 3 轮）
     a. 选择校验标准（见第四节）
     b. 逐条校验
     c. 发现问题 → 直接修正方案，不问用户
     d. 修正后重新校验（优先检查修正引入的新问题，然后用不同维度）
     e. 退出条件（先满足的生效）：
        - 某轮所有选定的校验项全部通过（通用 G1-G9 必做 + 追加项按场景选）→ 通过
        - 达到 3 轮 → 输出当前方案，未通过项标记为“⚠️ 待用户决策”
     f. 在方案文档的"自校验结果"节记录每轮校验过程

0-5. 输出定稿方案 → 等待用户确认
```

**核心理念**：
- **0-1 强制读取规则** — WS 不会自动读取 `.claude/CLAUDE.md`，必须显式读取，保证 CC 和 WS 行为一致
- **0-1 迭代式深度读取** — 从关键词搜索开始，沿引用链展开，完整读取每个文件（不只看摘要），直到覆盖所有上下游
- **0-2 设计决策显式化** — 把隐含的决策点暴露出来，让用户一次性审阅，避免后续反复
- **0-4 自校验 + 自修正** — AI 自己发现问题、自己修正，不等用户反馈。输出的方案已经过校验

---

## 三、方案文档模板

每次生成的方案文档**必须**包含以下节（简单变更可在对应节写“无”或“不适用”，但不能省略节本身）：

```markdown
# {方案名称}

> 设计原则：一看就懂、每个节点只做一件事、出口统一、上游有问题就停、
> 最少概念、最短路径、改动自洽、简约不等于省略。

## 一、目标
- 一句话描述要做什么
- 做到什么程度（验收标准）

## 二、前置条件与假设
- 假设 1: ...
- 假设 2: ...

## 三、现状分析
- 相关文件/模块列表
- 上下游依赖关系
- 当前逻辑/流程描述
- 存在的问题

## 四、设计决策
| # | 决策点 | 选项 | 推荐 | 理由 |
|---|--------|------|------|------|
| 1 | ... | A/B/C | A | ... |

## 五、目标状态
- 整体流程图（如适用）
- 关键逻辑/伪代码（如适用）
- 关键点说明

## 六、执行清单
| # | 文件/模块 | 位置 | 当前值 | 目标值 |
|---|-----------|------|--------|--------|

## 七、自校验结果
从 implement-fix-plan 工作流的「自校验标准」中选择适用的校验项，逐条填写：
| 校验项 | 通过？ | 说明 |
|--------|--------|------|
| ... | ✅/⚠️ | ... |
```

---

## 四、自校验标准

### 通用校验（所有方案必做）

| # | 校验项 | 方法 |
|---|--------|------|
| G1 | 一看就懂 | 流程图/执行清单 5 秒内能理解走向？ |
| G2 | 目标明确 | 验收标准是否可度量？做完了怎么判断"做完了"？ |
| G3 | 假设显式 | 所有隐含假设是否都列出了？ |
| G4 | 设计决策完整 | 是否有遗漏的决策点？每个决策是否有理由？ |
| G5 | 执行清单可操作 | 每项是否有明确的文件/位置/目标值？能直接执行吗？ |
| G6 | 正向流程走读 | 从头到尾走一遍，每步有输入/处理/输出？ |
| G7 | 改动自洽 | 改了 A，所有引用 A 的地方是否都检查了？ |
| G8 | 简约不等于省略 | 是否有必要的步骤/输出/校验被省略了？ |
| G9 | 场景模拟 | 用 2~3 个真实场景走一遍方案，看是否能跑通？ |

### 涉及框架流程时追加

| # | 校验项 | 方法 |
|---|--------|------|
| F1 | 文件同步 | 改了 Skill → 检查 Workflow/Command/state-machine；反之亦然 |
| F2 | 状态一致性 | 新增/修改的状态在 state-machine.yaml 中有定义？ |
| F3 | 交叉引用 | grep 所有被修改/删除/新增的关键词，确认零残留 |

### 涉及代码修改时追加

| # | 校验项 | 方法 |
|---|--------|------|
| C1 | 根因定位 | 修复的是根因还是症状？ |
| C2 | 接口兼容 | 函数签名/参数是否与调用方一致？ |
| C3 | 回归风险 | 修改是否可能破坏现有功能？ |
| C4 | 测试覆盖 | 是否需要新增或更新测试？ |

### 涉及新功能时追加

| # | 校验项 | 方法 |
|---|--------|------|
| N1 | 需求覆盖 | 所有需求点是否都有对应的执行项？ |
| N2 | 接口设计 | 新接口是否与现有架构一致？ |
| N3 | 测试设计 | 是否有测试方案？ |

### 混合场景

一个方案可能同时涉及多种场景。**通用校验必做 + 涉及哪种追加哪种**。

---

## 五、对 implement-fix-plan.md 的具体修改

### 执行清单

| # | 位置 | 当前值 | 目标值 |
|---|------|--------|--------|
| 1 | Phase 0 节（"### Phase 0: 方案生成"整节替换） | 4 步（分析→评估→生成→确认） | 5 步（读取上下文→分析+设计决策→生成→自校验+自修正→输出） |
| 2 | Phase 0 节之后、Phase 1 节之前 | 无 | 新增"方案文档模板"节 |
| 3 | "## 硬约束"节之前 | 无 | 新增"自校验标准"节（通用 + 追加） |
| 4 | 硬约束 Phase 0 | 3 条 | 新增：禁止不做自校验、禁止不修正就输出、必须含自校验结果节、必须含设计决策节 |
| 5 | Phase 1 | 模式 A 读取方案 | 增加：检查方案文档必选节是否齐全，缺少则提示补充 |
| 6 | Phase 3 | 逐项校验 | 增加"修改是否与设计决策一致"检查项 |

### 自校验结果
| 校验项 | 通过？ | 说明 |
|--------|--------|------|
| G1 一看就懂 | ✅ | 5 步线性流程，每步有明确输入输出 |
| G2 目标明确 | ✅ | "max 3 轮成型"可度量 |
| G3 假设显式 | ✅ | 假设：WS 不自动读取 CLAUDE.md、Phase 1~6 基本不变、AI 有足够 context window、用户能清晰描述需求 |
| G4 设计决策完整 | ✅ | 关键决策：5 步 vs 8 步、自校验分层（通用+追加）、安全阀 max 3 轮、“某轮 0 问题即通过”（理由：方案校验不同于代码校验，不需连续两轮） |
| G5 执行清单可操作 | ✅ | 6 项，每项有位置和目标值 |
| G6 正向流程走读 | ✅ | 0-1 读取→0-2 分析→0-3 生成→0-4 校验→0-5 输出，每步有明确产物 |
| G7 改动自洽 | ✅ | Phase 1 增加兼容检查，Phase 3 增加设计决策检查，其余不变 |
| G8 简约不等于省略 | ✅ | 模板含验收标准、前置条件、设计决策、自校验结果，无省略 |
| G9 场景模拟 | ✅ | 5 个真实场景验证通过（split-story优化/admin操作日志/模式A缺节/修正引入问题/架构设计） |
| F1 文件同步 | ✅ | 本项目无对应 CC Command（implement-fix-plan 仅作为 WS Workflow 存在） |
| F2 状态一致性 | ✅ | 不涉及新增/修改状态 |
| F3 交叉引用 | ✅ | 不涉及删除/重命名关键词 |

---

## 六、预期效果

| 指标 | 当前 | 目标 |
|------|------|------|
| 方案成型轮次 | 5~10 轮 | max 3 轮 |
| 用户需要发现的问题数 | 多 | 少（AI 自校验已覆盖） |
| 方案文档质量 | 逐步提升 | 第一轮就高质量 |
| 适用范围 | 仅代码修复 | 任何开发任务（框架流程/代码/新功能/文档） |
