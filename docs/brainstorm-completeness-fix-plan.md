# Brainstorm 业务闭环完整性修复方案

> 设计原则：一看就懂、每个节点只做一件事、出口统一、上游有问题就停、
> 最少概念、最短路径、改动自洽、简约不等于省略。

## 一、目标

- **一句话**：修复 prototype-extraction 和 brainstorming 两个 Skill 中"前置页面遗漏"和"业务闭环校验缺失"的系统性缺陷
- **验收标准**：
  1. PE Step 1 矩阵能自动识别登录页、错误页等非菜单页面
  2. BS Phase 2 正向校验能检测到"PRD 缺少业务入口页面"的情况
  3. BS Phase 4 输出逻辑严格按伪代码执行，B/C/D 类问题必须写入 open-questions.md
  4. 重新跑 `/brainstorm permission` 时，登录页被纳入矩阵，open-questions.md 被正确生成

## 二、前置条件与假设

- 假设 1: HTML 原型中的非菜单页面（登录页、错误页）通过 `<div class="page" id="page-xxx">` 或 `<div class="login-*">` 等模式可被 grep 识别
- 假设 2: 每个模块都有明确的"业务入口"（如 permission 模块的入口是登录页），可以通过原型结构推断
- 假设 3: Step 2 双通道提取和 Step 4 PRD 生成的核心逻辑不需要修改，但需要补充前置页面的适配说明（通道 B 源码定位方式、PRD 命名规则）

## 三、现状分析

### 相关文件

| 文件 | 角色 | 问题 |
|------|------|------|
| `.claude/skills/prototype-extraction/SKILL.md` | PE 定义 | Step 1 [1.2] 只 grep `showPage(` 提取侧边栏菜单，遗漏非菜单页面 |
| `.claude/skills/brainstorming/SKILL.md` | BS 定义 | Phase 2 正向校验无"业务入口闭环"检查；Phase 4 输出约束不够强 |

### 上下游依赖

```
config.yaml (module_prototype_map)
  → PE Step 1 (建立矩阵) ← 缺陷1: 只扫描菜单页面
    → PE Step 2~4 (提取+生成PRD)
      → BS Phase 1 (生成SRS)
        → BS Phase 2 (校验) ← 缺陷2: 无业务入口闭环检查
          → BS Phase 3 (终审)
            → BS Phase 4 (全量校验) ← 缺陷3: 输出约束不够强
              → open-questions.md / brainstorm_done
```

### 存在的问题

1. **PE Step 1 矩阵不完整**：`[1.2]` 只用 `grep "showPage("` 提取侧边栏菜单项。登录页（`<div class="login-container">`）、403/404 页面等不在侧边栏中的页面被遗漏。`[1.4]` 说"人工确认无遗漏"但没有给出前置页面检查清单。

2. **BS Phase 2 "最小路径"检查盲区**：正向校验的"最小路径"只检查 SRS 内部步骤连贯性。当 PRD 本身缺了登录页时，SRS 也缺，但"SRS 内部步骤"看起来连贯（因为根本没提到登录），导致"一致地缺失"无法被检测。

3. **BS Phase 4 输出执行不严格**：伪代码 L486-504 明确要求 B/C/D 类问题写入 open-questions.md 并阻塞，但缺少硬约束节的强制规则，导致执行时被跳过。

## 四、设计决策

| # | 决策点 | 选项 | 推荐 | 理由 |
|---|--------|------|------|------|
| 1 | 前置页面扫描方式 | A: 在 [1.2] 中增加额外 grep 模式 / B: 新增独立步骤 [1.2b] | B | 职责分离：[1.2] 负责菜单页面，[1.2b] 负责非菜单页面，各自清晰 |
| 2 | 前置页面识别模式 | A: 硬编码 grep 模式 / B: 在 config.yaml 中配置 | A | 最短路径：前置页面类型有限（login/error/global），硬编码足够，不需要过度配置化 |
| 3 | 业务入口闭环检查位置 | A: 加在正向校验第6项 / B: 加在反向校验 / C: 加在 UI 专项 | A | 正向校验的"最小路径"本身就应该包含入口检查，增加第6项最自然 |
| 4 | Phase 4 输出约束 | A: 只在硬约束节加规则 / B: 在伪代码中也加注释 | A | 伪代码已经写了逻辑（L486-504），问题是执行时跳过了，在硬约束节加强制规则即可 |

## 五、目标状态

### PE Step 1 流程（修改后）

```
Step 1: 建立端×页面全量矩阵
  [1.1] 扫描 config.prd_process.module_prototype_map
  [1.2] grep "showPage(" 提取侧边栏菜单页面
  [1.2b] 扫描前置/全局页面（登录页、错误页、全局组件）  ← 新增
        grep 'class="login' / id="page-login" / id="page-403" 等
        检查 HTML 中是否有独立于侧边栏的页面区块
        ⚠️ 扫描结果为空是正常情况（多数模块无独立前置页面），不报错
  [1.3] 合并 [1.2] + [1.2b] 结果，生成矩阵
        前置页面在矩阵中标注 🔑（前置）
  [1.4] 矩阵确认规则（增加前置页面检查清单）
  [1.5] 空矩阵检查
```

### BS Phase 2 正向校验（修改后）

```
正向校验（6 项）← 原 5 项
| 检查项     | 检查问题                                           |
|------------|---------------------------------------------------|
| 细节层级   | 每个功能点是否有输入/输出/约束？                    |
| 最小路径   | 能否找到遗漏的步骤？                                |
| 影响分析   | 是否分析了对其他模块的影响？                        |
| 错误处理   | 每个操作的异常情况是否定义？                        |
| 标准合规   | 是否符合 IEEE 830 要素？                            |
| 业务入口闭环 | 用户从进入系统到完成目标的完整旅程是否覆盖？      | ← 新增
               独立于 PRD 覆盖率检查，直接对照原型 HTML 验证
               必须回答：用户如何进入系统？（登录/注册）
                         用户如何离开系统？（退出/超时）
                         是否有错误兜底页面？（403/404/500）
```

### PE Step 2/4 前置页面适配（补充说明）

```
Step 2 通道 B 适配：
  前置页面（🔑标注）不要求 id="page-{pageId}" 格式
  改为按实际 HTML 结构定位（如 class="login-container"、id="error-403" 等）
  其余 B2-B14 检查项正常执行

Step 4 PRD 命名适配：
  前置页面用 00 编号：00-{role}-{page}.md
  如：00-admin-login.md（登录页）
  正常菜单页面仍从 01 开始编号
```

### BS 硬约束节（修改后）

```
新增规则：
- **Phase 4 发现 B/C/D 类问题时，必须写入 {module}-open-questions.md** — 禁止跳过
- **Phase 4 有 open_questions 时，必须设置 brainstorm_pending_confirm** — 禁止自动继续
```

## 六、执行清单

| # | 批次 | 文件 | 位置 | 当前值 | 目标值 | 优先级 |
|---|------|------|------|--------|--------|--------|
| 1 | Batch 1 | `.claude/skills/prototype-extraction/SKILL.md` | L40-49 流程图 Step 1 | [1.2] 只有 showPage grep | [1.2] 后增加 [1.2b] 前置/全局页面扫描 | 🔴高 |
| 2 | Batch 1 | `.claude/skills/prototype-extraction/SKILL.md` | L142-172 详细规则 1.2~1.4 | 无前置页面扫描规则 | 1.2 后新增 "1.2b 扫描前置/全局页面" 小节 + 1.4 增加前置页面检查清单 | 🔴高 |
| 3 | Batch 2 | `.claude/skills/brainstorming/SKILL.md` | L103-111 正向校验表 | 5 项 | 增加第 6 项"业务入口闭环" | 🔴高 |
| 4 | Batch 2 | `.claude/skills/brainstorming/SKILL.md` | L259-268 Phase 2 伪代码正向校验 | FORWARD_CHECKS 5 项 | 增加第 6 项 check_business_entry_loop | 🔴高 |
| 5 | Batch 2 | `.claude/skills/brainstorming/SKILL.md` | L595-609 硬约束节 | 无 Phase 4 输出强制规则 | 增加 2 条 Phase 4 输出硬约束 | 🟡中 |
| 5b | Batch 1 | `.claude/skills/prototype-extraction/SKILL.md` | L198 通道B规则 B1 | `id="page-{pageId}"` 硬编码 | 增加前置页面（🔑）的替代定位说明 | 🟡中 |
| 5c | Batch 1 | `.claude/skills/prototype-extraction/SKILL.md` | L96-104 Step 4 命名规则 | `{NN}-{role}-{page}.md` 从 01 开始 | 增加前置页面用 00 编号的规则 | 🟡中 |

## 七、自校验结果

### 第 1 轮

| 校验项 | 通过？ | 说明 |
|--------|--------|------|
| G1 一看就懂 | ✅ | 3 个缺陷 → 5 个修改项，流程清晰 |
| G2 目标明确 | ✅ | 4 个验收标准均可度量 |
| G3 假设显式 | ✅ | 3 个假设已列出 |
| G4 设计决策完整 | ✅ | 4 个决策点，每个有选项和理由 |
| G5 执行清单可操作 | ✅ | 每项有文件/位置/当前值/目标值 |
| G6 正向流程走读 | ✅ | PE Step 1 → BS Phase 2 → BS Phase 4，每步有输入/处理/输出 |
| G7 改动自洽 | ⚠️ | 正向校验从 5 项变 6 项，需检查引用 "5/5" 的地方 |
| G8 简约不等于省略 | ✅ | 3 个缺陷各有对应修复，无遗漏 |
| G9 场景模拟 | ✅ | permission 模块：登录页被 [1.2b] 识别 → 纳入矩阵 → PRD 生成 → SRS 覆盖 → Phase 2 "业务入口闭环"通过 |
| F1 文件同步 | ✅ | 只改 Skill 文件，无 Workflow/state-machine 变更 |

### G7 修正

发现 G7 问题：正向校验从 5 项变 6 项，需要检查 SKILL.md 中所有引用 "5/5" 的地方。

搜索后发现：
- L270: `print("  正向校验: ✅ 5/5 通过")` → 需改为 `6/6`
- L639: 迭代计数示例 `正向校验: ✅ 5/5 通过` → 需改为 `6/6`

追加到执行清单：

| # | 批次 | 文件 | 位置 | 当前值 | 目标值 | 优先级 |
|---|------|------|------|--------|--------|--------|
| 6 | Batch 2 | `.claude/skills/brainstorming/SKILL.md` | L270 伪代码 | `正向校验: ✅ 5/5 通过` | `正向校验: ✅ 6/6 通过` | 🟡中 |
| 7 | Batch 2 | `.claude/skills/brainstorming/SKILL.md` | L636 迭代计数示例 | `正向校验: ✅ 5/5 通过` | `正向校验: ✅ 6/6 通过` | 🟡中 |
| 8 | Batch 2 | `.claude/skills/brainstorming/SKILL.md` | L639 迭代计数示例 | `UI 专项校验: ✅ 5/5 通过` | `UI 专项校验: ✅ 6/6 通过`（已有6项，修正已有错误） | 🟢低 |

### 第 2 轮（修正后重新校验）

| 校验项 | 通过？ | 说明 |
|--------|--------|------|
| G7 改动自洽 | ✅ | 已追加 #6 #7 修改项，"5/5" → "6/6" 全部覆盖 |
| G9 场景模拟（补充） | ✅ | 场景2: base-data 模块无登录页 → [1.2b] 扫描结果为空 → 矩阵只含菜单页面 → 正常流程不受影响 |

第 2 轮全部通过 ✅

### 第 3 轮（维度 H 交叉影响 + 维度 C 数据流）

| 校验项 | 通过？ | 说明 |
|--------|--------|------|
| H1 PE [1.2b] 与 Step 2 衔接 | ⚠️→✅ | 前置页面的通道B源码分析不符合 `id="page-{pageId}"` 格式 → 补充适配说明 + 执行清单 #5b |
| H2 PE [1.2b] 与 Step 4 命名 | ⚠️→✅ | 前置页面 PRD 命名未定义 → 补充 00 编号规则 + 执行清单 #5c |
| H3 BS 正向校验与 Phase 4 | ✅ | 互补不冲突 |
| H4 硬约束与伪代码 | ✅ | 加强执行约束，不矛盾 |
| C1 前置页面数据流 | ⚠️→✅ | 同 H1，已补充适配说明 |

修正后追加 2 项到执行清单（#5b, #5c），总计 10 项。

### 第 4 轮（修正后确认）

| 校验项 | 通过？ | 说明 |
|--------|--------|------|
| G7 改动自洽 | ✅ | 10 项修改覆盖了所有交叉影响 |
| G8 简约不等于省略 | ✅ | Step 2/4 适配已补充 |
| G9 场景模拟 | ✅ | permission: login → [1.2b]识别 → 矩阵🔑 → Step2按class定位 → Step4命名00-admin-login.md → SRS覆盖 |

第 3~4 轮全部通过 ✅（连续2轮无新问题）

### 第 5 轮（维度 D 兼容性 + E 防御性 + I 回归风险）

| 校验项 | 通过？ | 说明 |
|--------|--------|------|
| D1 [1.2b] 与 config.yaml 兼容 | ✅ | 不依赖新配置字段 |
| D2 正向校验第6项与 Phase 3 终审 | ✅ | 终审维度优先级不受影响 |
| D3 硬约束与 state-machine.yaml | ✅ | brainstorm_pending_confirm 已有定义 |
| E1 [1.2b] 扫描为空时的处理 | ⚠️→✅ | 未明确 → 补充"扫描为空是正常情况，不报错" |
| E2 业务入口闭环检查失败处理 | ✅ | 复用正向校验的 enhance_doc 逻辑 |
| I1 非 permission 模块影响 | ✅ | 增量扫描，不影响现有结果 |
| I2 门控脚本更新 | ✅ | 前置页面 PRD 自动计入，无需修改 |

修正 E1 后，目标状态 [1.2b] 增加"扫描为空不报错"说明。

### 第 6 轮（修正后确认）

| 校验项 | 通过？ | 说明 |
|--------|--------|------|
| E1 | ✅ | 已补充 |
| G7 改动自洽 | ✅ | 10 项修改 + E1 说明，无遗漏 |

第 5~6 轮全部通过 ✅（连续2轮无新问题）
