# verification 严谨性增强方案

> 设计原则：一看就懂、每个节点只做一件事、出口统一、上游有问题就停、
> 最少概念、最短路径、改动自洽、简约不等于省略。

## 一、目标

- 对齐 verification/SKILL.md 与其他 Skill 的严谨性结构
- 验收标准：补充迭代计数示例 + 失败退出规则覆盖 Phase 1

## 二、前置条件与假设

- 假设 1: story-splitter / ticket-splitter / deliver-ticket 已完成增强
- 假设 2: verification/SKILL.md 当前 462 行，已有失败退出规则（Phase 2 + Phase 3）

## 三、现状分析

**相关文件**：
- `.claude/skills/verification/SKILL.md` — 目标文件
- `.windsurf/workflows/verify.md` — 对应 workflow（无需修改）

**上下游依赖**：
- 上游：deliver-ticket 调用 `verify_story()`
- 下游：返回 passed/failed，调用方更新 STATE.yaml

**存在的问题**：

| # | 问题 | 严重度 | 说明 |
|---|------|--------|------|
| V-1 | 缺少迭代计数示例 | 🟡中 | Phase 2 验收迭代 + Phase 3 终审轮次无输出格式示例 |
| V-2 | 失败退出规则缺少 Phase 1 | 🟢低 | 前置检查失败路径未在独立段落中覆盖 |

## 四、设计决策

| # | 决策点 | 选项 | 推荐 | 理由 |
|---|--------|------|------|------|
| 1 | 迭代示例位置 | A: 输出格式之后 / B: 失败退出规则之后 | B | 与 deliver-ticket 结构一致（失败退出→迭代计数→硬约束） |
| 2 | Phase 1 失败路径措辞 | A: "返回 failed" / B: "返回 {passed: False}" | B | verification 是纯函数，不更新状态，用返回值表达 |

## 五、目标状态

修改后 verification/SKILL.md 应具备：
- 失败退出规则覆盖 Phase 1 / Phase 2 / Phase 3 三个阶段
- 迭代计数示例展示 Phase 2 验收迭代 + Phase 3 终审轮次的输出格式

## 六、执行清单

### V-1: 补充迭代计数示例（🟡中）

**文件**: `.claude/skills/verification/SKILL.md`
**位置**: 第 447 行（失败退出规则 ``` 结束后）和第 449 行（硬约束段落前）之间
**操作**: 插入

```markdown
## 迭代计数强制规则

每轮验收迭代和增强终审必须输出进度，格式如下：

` ` `
=== Phase 2: 功能验收 ===
🔄 验收迭代 1/5
  全量测试: ✅ 后端 mvn test → exit_code=0
  AC 覆盖率: ❌ 1 个 AC 未覆盖
  覆盖率: ✅ 分支 100%, 行 92%

🔄 验收迭代 2/5
  全量测试: ✅ 通过
  AC 覆盖率: ✅ 8/8 = 100%
  覆盖率: ✅ 达标

Phase 2 功能验收: ✅ 全部通过

=== Phase 3: 增强全局终审 ===
🔍 终审轮次 1/10 (维度 I — 命名一致性)
  三维度终审:
    上游一致性: ✅ 所有 Tickets 证据有效
    下游可行性: ✅ 无文件冲突
    全局完整性: ✅ 所有 AC 满足
  多维度校验 (I): ✅ 无问题

🔍 终审轮次 2/10 (维度 H — 交叉影响)
  三维度终审: ✅ 3/3
  多维度校验 (H): ✅ 无问题

🎉 连续 2 轮无修改，终审通过
` ` `
```

### V-2: 失败退出规则补充 Phase 1（🟢低）

**文件**: `.claude/skills/verification/SKILL.md`
**位置**: 第 435 行（失败退出规则 ``` 开始后、Phase 2 失败前）
**操作**: 在 Phase 2 失败之前插入

```
⚠️ Phase 1 失败：前置检查未通过（Ticket 状态非 done / 缺少证据 / exit_code 非 0）：
1. 输出失败报告（列出所有未通过的 Ticket 及原因）
2. 返回 {"passed": False, "phase": "pre_check"} — 不更新任何状态（纯函数）
3. 调用方负责状态处理
4. 用户需修复 Ticket 问题后重新执行 /verify
```

## 七、自校验结果

### 第 1 轮（通用 G1-G9）

| 校验项 | 通过？ | 说明 |
|--------|--------|------|
| G1 目标明确 | ✅ | 2 项修改，位置和内容明确 |
| G2 影响范围完整 | ✅ | 仅 1 个文件，无下游影响 |
| G3 执行清单可操作 | ✅ | 有文件、行号、操作类型 |
| G4 设计决策有理由 | ✅ | 2 个决策都有理由 |
| G5 前置条件满足 | ✅ | 其他 Skill 已修复 |
| G6 违反设计原则 | ✅ | 无 |
| G7 执行顺序正确 | ✅ | V-1 先（第 447 行，靠后），V-2 后（第 435 行，靠前）— 从末尾到开头避免行号偏移 |
| G8 遗漏修改项 | ✅ | 对比其他 Skill，verification 只缺这 2 项 |
| G9 自洽 | ✅ | V-2 的 Phase 1 失败路径与伪代码第 160-169 行一致 |

### 第 2 轮（文件同步 F1）

| 校验项 | 通过？ | 说明 |
|--------|--------|------|
| F1 workflow 需要更新 | ✅ | verify.md 无需更新 |

全部通过。
