# 项目配置

本文档定义项目配置文件结构、目录结构和初始化流程。

---

## project/config.yaml

```yaml
# 项目基本信息
name: ruoyi-vue
type: fullstack  # backend | frontend | fullstack | mobile

# 技术栈
tech_stack:
  backend:
    language: java
    framework: spring-boot
    version: "2.5"
  frontend:
    language: javascript
    framework: vue
    version: "2.6"
  database:
    type: mysql
    version: "8.0"

# 命令映射（逻辑命令 → 实际命令）
# 注意：请先验证命令是否可用（mvn help:describe -Dplugin=checkstyle）
commands:
  test: "mvn -q test"
  test-single: "mvn -q test -Dtest={class}"
  build: "mvn -q -DskipTests package"
  # 若 checkstyle 插件未配置，使用 build 作为 fallback
  lint: "mvn checkstyle:check || mvn -q -DskipTests compile"
  lint-fix: "mvn checkstyle:check || true"  # Java 无自动修复
  run: "mvn -pl ruoyi-admin -am spring-boot:run"
  
  # 前端命令（若依项目）
  frontend:
    install: "cd ruoyi-ui && npm install"
    build: "cd ruoyi-ui && npm run build:prod"
    # 若无 lint 脚本，使用 || true 避免阻塞流程
    lint: "cd ruoyi-ui && npm run lint || true"
    run: "cd ruoyi-ui && npm run dev"

# 命令验证说明
# 在项目初始化时，建议执行以下命令验证：
# 1. mvn help:describe -Dplugin=checkstyle  # 检查 checkstyle 是否可用
# 2. cd ruoyi-ui && cat package.json | grep lint  # 检查前端 lint 是否存在
# 如命令不存在，应相应调整 config.yaml 或在 Ticket 中标注跳过

# 目录约定
paths:
  backend:
    controllers: "ruoyi-admin/src/main/java/**/controller/"
    services: "ruoyi-system/src/main/java/**/service/"
    mappers: "ruoyi-system/src/main/java/**/mapper/"
    tests: "ruoyi-*/src/test/java/"
  frontend:
    pages: "ruoyi-ui/src/views/"
    api: "ruoyi-ui/src/api/"
    components: "ruoyi-ui/src/components/"

# 启用的开发者角色
developers:
  - backend-java
  - frontend-vue
  - dba-mysql

# 审批配置
approval:
  story_split: required      # required | optional | auto
  ticket_split: required
  ticket_done: auto          # 单个 Ticket 完成后自动继续
  story_done: required       # Story 完成需要人工确认
  
  # 自动审批条件（当 ticket_done: auto 时）
  auto_approve_if:
    tests_pass: true
    lint_pass: true

# 记忆配置
memory:
  compression_threshold: 70%  # 上下文使用率达到此值时触发压缩
  checkpoint_interval: "per_ticket"  # per_ticket | per_story | manual
  
# 错误处理配置
error_handling:
  test_max_retries: 3
  lint_auto_fix: true
  on_path_violation: "stop_and_report"  # stop_and_report | auto_rollback
  
# Ralph Loop 配置
ralph_loop:
  default_max_iterations: 20
  verification_command: "mvn test"

# 执行策略配置
execution:
  # 执行模式: sequential(顺序) | parallel(并行) | priority(优先级)
  mode: sequential
  
  # 顺序模式配置
  sequential:
    # Story 执行顺序: by_priority | by_id | by_dependency
    order: by_priority
    
  # 并行模式配置（可选，需要 Git Worktree）
  # parallel:
  #   max_parallel_stories: 2
  #   isolation: worktree

# 代码规范引用
rules_reference:
  java: "https://github.com/alibaba/p3c"  # 阿里 Java 规范
  vue: "https://vuejs.org/style-guide/"
  sql: "internal"
```

---

## 完整目录结构

```
.claude/
├── core/                        # 【不变】核心框架（可复制到任何项目）
│   │
│   ├── skills/                  # 核心技能（13 个）
│   │   │
│   │   ├── # 记忆管理类
│   │   ├── memory-bank/
│   │   │   └── SKILL.md
│   │   ├── context-compression/
│   │   │   └── SKILL.md
│   │   ├── checkpoint-manager/
│   │   │   └── SKILL.md
│   │   │
│   │   ├── # 自动化类
│   │   ├── ralph-loop/
│   │   │   └── SKILL.md
│   │   ├── progress-tracker/
│   │   │   └── SKILL.md
│   │   │
│   │   ├── # 工作流类
│   │   ├── brainstorming/
│   │   │   └── SKILL.md
│   │   ├── story-splitter/
│   │   │   └── SKILL.md
│   │   ├── ticket-splitter/
│   │   │   └── SKILL.md
│   │   ├── deliver-ticket/
│   │   │   └── SKILL.md
│   │   │
│   │   ├── # 质量类
│   │   ├── verification/
│   │   │   └── SKILL.md
│   │   ├── tdd/
│   │   │   └── SKILL.md
│   │   ├── code-review/
│   │   │   └── SKILL.md
│   │   └── debugging/
│   │       └── SKILL.md
│   │
│   ├── agents/                  # 角色模板（7 个）
│   │   ├── coordinator.md       # 协调员
│   │   ├── architect.md         # 架构师
│   │   ├── planner.md           # 计划员
│   │   ├── developer.md         # 开发者通用模板
│   │   ├── reviewer.md          # 评审员
│   │   └── qa.md                # QA
│   │
│   └── templates/               # 文件模板
│       ├── story.yaml
│       ├── ticket.yaml
│       ├── checkpoint.yaml
│       ├── log.yaml
│       └── state.yaml
│
├── project/                     # 【可变】项目配置
│   │
│   ├── config.yaml              # 项目配置（技术栈、命令映射、审批配置）
│   │
│   ├── agents/                  # 项目角色实例（继承通用模板）
│   │   ├── backend-java.md      # Java 后端开发者
│   │   ├── frontend-vue.md      # Vue 前端开发者
│   │   └── dba-mysql.md         # MySQL DBA
│   │
│   └── rules/                   # 项目代码规范（引用外部规范）
│       ├── java.md              # 引用阿里 Java 规范
│       ├── vue.md
│       └── sql.md
│
├── memory/                      # 持久化记忆
│   ├── session.yaml             # 当前会话状态
│   ├── decisions.yaml           # 重要决策记录
│   └── summaries/               # 历史摘要
│       └── {date}.md
│
├── checkpoints/                 # 检查点
│   └── CP-{timestamp}.yaml
│
├── CLAUDE.md                    # 项目入口（引用 core + project）
│
└── commands/                    # 快捷命令
    ├── brainstorm.md
    ├── split.md
    ├── next.md
    ├── status.md
    ├── approve.md               # 审批命令
    ├── checkpoint.md
    ├── restore.md
    ├── rollback.md              # 回滚命令
    └── ralph-loop.md

docs/
└── requirements/                # 需求文档（用户放置）
    └── REQ-001.md

tasks/
├── STATE.yaml                   # 全局状态文件
├── stories/
│   └── S-001.yaml
└── tickets/
    └── T-001.yaml

workspace/
└── logs/                        # 执行日志
    └── T-001.yaml

artifacts/
├── reports/
└── reviews/                     # 代码评审记录
    └── T-001.md
```

---

## CLAUDE.md 入口文件

```markdown
# 一人公司 AI 交付框架

## 加载配置
- 核心框架: .claude/core/
- 项目配置: .claude/project/config.yaml
- 当前状态: tasks/STATE.yaml

## 可用命令
| 命令 | 说明 |
|------|------|
| /brainstorm | 头脑风暴，细化需求 |
| /split story | 将需求拆解为 Story |
| /split ticket S-xxx | 将 Story 拆解为 Ticket |
| /approve stories | 审批 Story 拆解 |
| /approve tickets | 审批 Ticket 拆解 |
| /next | 执行下一个 Ticket |
| /status | 查看当前进度 |
| /checkpoint | 手动保存检查点 |
| /restore CP-xxx | 恢复到检查点 |
| /rollback T-xxx | 回滚 Ticket |

## 工作流
Research → Plan → Implement → Validate

## 当前角色
根据 Ticket 类型自动分派：
- backend → backend-java Agent
- frontend → frontend-vue Agent
- database → dba-mysql Agent

## 记忆管理
- 上下文阈值: 70%（超过自动压缩）
- 检查点: 每个 Ticket 完成后自动保存
- 决策记录: memory/decisions.yaml

## 规范引用
- Java: 阿里巴巴 Java 开发手册
- Vue: Vue 官方风格指南
```

---

## 项目初始化流程

### 方式一：手动初始化

```bash
# 1. 复制核心框架
cp -r /path/to/core-template/.claude/core .claude/core

# 2. 创建项目目录结构
mkdir -p .claude/project/agents
mkdir -p .claude/project/rules
mkdir -p .claude/memory/summaries
mkdir -p .claude/checkpoints
mkdir -p .claude/commands
mkdir -p docs/requirements
mkdir -p tasks/stories
mkdir -p tasks/tickets
mkdir -p workspace/logs
mkdir -p artifacts/reviews

# 3. 创建项目配置
# 编辑 .claude/project/config.yaml

# 4. 创建 CLAUDE.md
# 编辑 .claude/CLAUDE.md

# 5. 初始化状态
# 创建 tasks/STATE.yaml（空状态）
```

### 方式二：使用初始化命令

```bash
/init-project ruoyi-vue --stack java,vue,mysql
```

该命令会自动：

1. 检测项目类型
2. 生成 `project/config.yaml`
3. 生成对应的 Agent 实例
4. 初始化 `tasks/STATE.yaml`
5. 创建 `CLAUDE.md`

---

## 复用到新项目

当开始一个新项目（如 Python 项目）：

### 1. 复制 core/ 目录（不变）

```bash
cp -r .claude/core /new-project/.claude/core
```

### 2. 创建新的 project/ 配置

```yaml
# project/config.yaml
name: my-python-api
tech_stack:
  backend:
    language: python
    framework: fastapi
commands:
  test: "pytest"
  lint: "ruff check ."
  lint-fix: "ruff check --fix ."
developers:
  - backend-python
memory:
  compression_threshold: 70%
rules_reference:
  python: "https://peps.python.org/pep-0008/"
```

### 3. 创建项目角色

`project/agents/backend-python.md`

### 4. 初始化目录

`memory/`, `checkpoints/`, `workspace/logs/`

---

## 相关文档

- [00_概览](00_概览.md) - 返回概览
- [30_格式规范](30_格式规范.md) - YAML 格式规范
- [32_命令体系](32_命令体系.md) - 命令说明
