# 项目配置

本文档定义项目配置文件结构、目录结构和初始化流程。

---

## ⚠️ config.yaml 是项目的核心

```
┌─────────────────────────────────────────────────────────────┐
│                     一人公司框架运行流程                      │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   用户执行命令  →  框架加载  →  读取 config.yaml  →  执行    │
│                                       ↑                     │
│                                       │                     │
│                              ⚠️ 没有它框架无法运行！          │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

**config.yaml 的作用**：

| Skills 执行 | 需要从 config.yaml 读取 |
|-------------|------------------------|
| `brainstorming` | `paths` → 找到项目文档 |
| `tdd` | `commands.test` → 执行测试命令 |
| `deliver-ticket` | `paths.source` → 知道代码放哪 |
| `verification` | `commands.build` → 验证构建 |
| 所有 Agents | `tech_stack` → 知道用什么技术 |

**移植框架到新项目的核心步骤**：
1. 复制 `.claude/core/` 和 `.claude/commands/`（通用部分）
2. **创建 `.claude/project/config.yaml`**（项目特定）← 这是关键！
3. 框架即可运行

---

## project/config.yaml

> ⚠️ **注意**：以下是**通用模板**，具体值需要根据实际项目填写。框架本身不依赖任何特定的技术栈版本。

```yaml
# ============================================
# 项目配置模板（请根据实际项目修改）
# ============================================

# 项目基本信息
name: "{project_name}"           # 项目名称，如 my-app
type: fullstack                  # backend | frontend | fullstack | mobile

# 技术栈（根据实际项目填写）
tech_stack:
  backend:
    language: "{language}"       # java | python | go | nodejs
    framework: "{framework}"     # spring-boot | django | gin | express
    version: "{version}"         # 框架版本，如 3.x、2.5
    runtime: "{runtime}"         # 运行时版本，如 Java 17、Python 3.11
  frontend:
    language: "{language}"       # javascript | typescript
    framework: "{framework}"     # vue | react | angular
    version: "{version}"         # 框架版本，如 3.x、18.x
    package_manager: "{pm}"      # npm | pnpm | yarn
  database:
    type: "{db_type}"            # mysql | postgresql | mongodb
    version: "{version}"         # 数据库版本，如 8.0

# 命令映射（逻辑命令 → 实际命令）
commands:
  # 后端命令（根据技术栈调整）
  test: "{test_command}"         # 如 mvn test、pytest、go test
  build: "{build_command}"       # 如 mvn package、pip install、go build
  lint: "{lint_command}"         # 如 mvn checkstyle:check、flake8
  run: "{run_command}"           # 如 mvn spring-boot:run、python manage.py runserver
  
  # 前端命令（根据包管理器调整）
  frontend:
    install: "{install_cmd}"     # 如 npm install、pnpm install
    build: "{build_cmd}"         # 如 npm run build
    lint: "{lint_cmd}"           # 如 npm run lint
    dev: "{dev_cmd}"             # 如 npm run dev
  
  # 运维命令（根据部署方式调整）
  ops:
    docker_build: "{docker_cmd}" # 如 docker build -t app .
    docker_run: "{docker_cmd}"   # 如 docker-compose up -d
    deploy: "{deploy_cmd}"       # 如 kubectl apply -f k8s/
    logs: "{logs_cmd}"           # 如 docker-compose logs -f
    health: "{health_cmd}"       # 如 curl http://localhost:8080/health

# 目录约定（根据项目结构调整）
paths:
  backend:
    source: "{backend_src}"      # 如 src/main/java、app/
    tests: "{backend_tests}"     # 如 src/test/java、tests/
    controllers: "{controllers}" # 如 **/controller/
    services: "{services}"       # 如 **/service/
    mappers: "{mappers}"         # 如 **/mapper/ 或 **/repository/
  frontend:
    source: "{frontend_src}"     # 如 src/、packages/
    components: "{components}"   # 如 src/components/
    pages: "{pages}"             # 如 src/views/、src/pages/

# 启用的开发者角色（根据项目需要选择）
developers:
  - backend-java      # 或 backend-python、backend-go
  - frontend-vue      # 或 frontend-react
  - dba-mysql         # 或 dba-postgresql

# 审批配置
approval:
  story_split: required      # required | optional | auto
  ticket_split: required
  ticket_done: auto          # 单个 Ticket 完成后自动继续
  story_done: required       # Story 完成需要人工确认
  
  # 自动审批条件（当 ticket_done: auto 时）
  auto_approve_if:
    tests_pass: true
    lint_pass: true

# 记忆配置
memory:
  compression_threshold: 70%  # 上下文使用率达到此值时触发压缩
  checkpoint_interval: "per_ticket"  # per_ticket | per_story | manual
  
# 错误处理配置
error_handling:
  test_max_retries: 3
  lint_auto_fix: true
  on_path_violation: "stop_and_report"  # stop_and_report | auto_rollback
  
# Ralph Loop 配置
ralph_loop:
  default_max_iterations: 20
  verification_command: "mvn test"

# 执行策略配置
execution:
  # 执行模式: sequential(顺序) | parallel(并行) | priority(优先级)
  mode: sequential
  
  # 顺序模式配置
  sequential:
    # Story 执行顺序: by_priority | by_id | by_dependency
    order: by_priority
    
  # 并行模式配置（可选，需要 Git Worktree）
  # parallel:
  #   max_parallel_stories: 2
  #   isolation: worktree

# 代码规范引用
rules_reference:
  java: "https://github.com/alibaba/p3c"  # 阿里 Java 规范
  vue: "https://vuejs.org/style-guide/"
  sql: "internal"
```

---

## 完整目录结构

```
.claude/
├── core/                        # 【不变】核心框架（可复制到任何项目）
│   │
│   ├── skills/                  # 核心技能（16 个）
│   │   │
│   │   ├── # 记忆管理类
│   │   ├── memory-bank/
│   │   │   └── SKILL.md
│   │   ├── context-compression/
│   │   │   └── SKILL.md
│   │   ├── checkpoint-manager/
│   │   │   └── SKILL.md
│   │   │
│   │   ├── # 自动化类
│   │   ├── ralph-loop/
│   │   │   └── SKILL.md
│   │   ├── progress-tracker/
│   │   │   └── SKILL.md
│   │   │
│   │   ├── # 工作流类
│   │   ├── brainstorming/
│   │   │   └── SKILL.md
│   │   ├── story-splitter/
│   │   │   └── SKILL.md
│   │   ├── ticket-splitter/
│   │   │   └── SKILL.md
│   │   ├── deliver-ticket/
│   │   │   └── SKILL.md
│   │   ├── using-git-worktrees/
│   │   │   └── SKILL.md
│   │   │
│   │   ├── # 质量类
│   │   ├── verification/
│   │   │   └── SKILL.md
│   │   ├── tdd/
│   │   │   └── SKILL.md
│   │   ├── code-review/
│   │   │   └── SKILL.md
│   │   ├── debugging/
│   │   │   └── SKILL.md
│   │   │
│   │   ├── # 平台适配类
│   │   ├── subagent-dispatch/
│   │   │   └── SKILL.md
│   │   └── hooks-manager/
│   │       └── SKILL.md
│   │
│   ├── agents/                  # 角色模板（6 个）
│   │   ├── coordinator.md       # 协调员
│   │   ├── architect.md         # 架构师
│   │   ├── planner.md           # 计划员
│   │   ├── developer.md         # 开发者通用模板
│   │   ├── reviewer.md          # 评审员
│   │   └── qa.md                # QA
│   │
│   ├── platform/                # 平台适配层
│   │   ├── interface.yaml       # 接口定义
│   │   ├── cursor/              # Cursor IDE 适配
│   │   │   ├── subagent.md
│   │   │   └── hooks.md
│   │   ├── claude-cli/          # Claude Code CLI 适配
│   │   │   ├── subagent.md
│   │   │   └── hooks.md
│   │   └── mcp/                 # MCP Server 适配
│   │       ├── subagent.md
│   │       └── hooks.md
│   │
│   └── templates/               # 文件模板
│       ├── story.yaml
│       ├── ticket.yaml
│       ├── checkpoint.yaml
│       ├── log.yaml
│       └── state.yaml
│
├── project/                     # 【可变】项目配置
│   │
│   ├── config.yaml              # 项目配置（技术栈、命令映射、审批配置）
│   │
│   ├── agents/                  # 项目角色实例（继承通用模板）
│   │   ├── backend-java.md      # Java 后端开发者
│   │   ├── frontend-vue.md      # Vue 前端开发者
│   │   └── dba-mysql.md         # MySQL DBA
│   │
│   └── rules/                   # 项目代码规范（引用外部规范）
│       ├── java.md              # 引用阿里 Java 规范
│       ├── vue.md
│       └── sql.md
│
├── memory/                      # 持久化记忆
│   ├── session.yaml             # 当前会话状态
│   ├── decisions.yaml           # 重要决策记录
│   └── summaries/               # 历史摘要
│       └── {date}.md
│
├── checkpoints/                 # 检查点
│   └── CP-{timestamp}.yaml
│
├── CLAUDE.md                    # 项目入口（引用 core + project）
│
└── commands/                    # 快捷命令
    ├── brainstorm.md
    ├── split.md
    ├── next.md
    ├── status.md
    ├── approve.md               # 审批命令
    ├── checkpoint.md
    ├── restore.md
    ├── rollback.md              # 回滚命令
    └── ralph-loop.md

docs/
└── requirements/                # 需求文档（用户放置）
    └── REQ-001.md

tasks/
├── STATE.yaml                   # 全局状态文件
├── stories/
│   └── S-001.yaml
└── tickets/
    └── T-001.yaml

workspace/
└── logs/                        # 执行日志
    └── T-001.yaml

artifacts/
├── reports/
└── reviews/                     # 代码评审记录
    └── T-001.md
```

---

## CLAUDE.md 入口文件

```markdown
# 一人公司 AI 交付框架

## 加载配置
- 核心框架: .claude/core/
- 项目配置: .claude/project/config.yaml
- 当前状态: tasks/STATE.yaml

## 可用命令
| 命令 | 说明 |
|------|------|
| /brainstorm | 头脑风暴，细化需求 |
| /split story | 将需求拆解为 Story |
| /split ticket S-xxx | 将 Story 拆解为 Ticket |
| /approve stories | 审批 Story 拆解 |
| /approve tickets | 审批 Ticket 拆解 |
| /next | 执行下一个 Ticket |
| /status | 查看当前进度 |
| /checkpoint | 手动保存检查点 |
| /restore CP-xxx | 恢复到检查点 |
| /rollback T-xxx | 回滚 Ticket |

## 工作流
Research → Plan → Implement → Validate

## 当前角色
根据 Ticket 类型自动分派：
- backend → backend-java Agent
- frontend → frontend-vue Agent
- database → dba-mysql Agent

## 记忆管理
- 上下文阈值: 70%（超过自动压缩）
- 检查点: 每个 Ticket 完成后自动保存
- 决策记录: memory/decisions.yaml

## 规范引用
- Java: 阿里巴巴 Java 开发手册
- Vue: Vue 官方风格指南
```

---

## 项目初始化流程

### 方式一：手动初始化

```bash
# 1. 复制核心框架
cp -r /path/to/core-template/.claude/core .claude/core

# 2. 创建项目目录结构
mkdir -p .claude/project/agents
mkdir -p .claude/project/rules
mkdir -p .claude/memory/summaries
mkdir -p .claude/checkpoints
mkdir -p .claude/commands
mkdir -p docs/requirements
mkdir -p tasks/stories
mkdir -p tasks/tickets
mkdir -p workspace/logs
mkdir -p artifacts/reviews

# 3. 创建项目配置
# 编辑 .claude/project/config.yaml

# 4. 创建 CLAUDE.md
# 编辑 .claude/CLAUDE.md

# 5. 初始化状态
# 创建 tasks/STATE.yaml（空状态）
```

### 方式二：使用初始化命令

```bash
/init-project ruoyi-vue --stack java,vue,mysql
```

该命令会自动：

1. 检测项目类型
2. 生成 `project/config.yaml`
3. 生成对应的 Agent 实例
4. 初始化 `tasks/STATE.yaml`
5. 创建 `CLAUDE.md`

---

## 复用到新项目

当开始一个新项目（如 Python 项目）：

### 1. 复制 core/ 目录（不变）

```bash
cp -r .claude/core /new-project/.claude/core
```

### 2. 创建新的 project/ 配置

```yaml
# project/config.yaml
name: my-python-api
tech_stack:
  backend:
    language: python
    framework: fastapi
commands:
  test: "pytest"
  lint: "ruff check ."
  lint-fix: "ruff check --fix ."
developers:
  - backend-python
memory:
  compression_threshold: 70%
rules_reference:
  python: "https://peps.python.org/pep-0008/"
```

### 3. 创建项目角色

`project/agents/backend-python.md`

### 4. 初始化目录

`memory/`, `checkpoints/`, `workspace/logs/`

---

## 相关文档

- [00_概览](00_概览.md) - 返回概览
- [30_格式规范](30_格式规范.md) - YAML 格式规范
- [32_命令体系](32_命令体系.md) - 命令说明
