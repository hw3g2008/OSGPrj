# å®ç°ç»†èŠ‚

æœ¬æ–‡æ¡£è¯´æ˜æ¡†æ¶ä¸­ä¸€äº›æŠ€æœ¯å®ç°çš„ç»†èŠ‚ï¼ŒåŒ…æ‹¬ Subagent è°ƒç”¨ã€ä¸Šä¸‹æ–‡æ£€æµ‹ã€Git é›†æˆç­‰ã€‚

---

## 1. Subagent è°ƒç”¨å®ç°

### é—®é¢˜èƒŒæ™¯

æ¡†æ¶è®¾è®¡ä¸­ä½¿ç”¨äº† `Task(agent="xxx", prompt="xxx")` è¯­æ³•æ¥è°ƒç”¨ Subagentï¼Œä½† Cursor ç›®å‰**ä¸åŸç”Ÿæ”¯æŒ**è¿™ç§è°ƒç”¨æ–¹å¼ã€‚

### è§£å†³æ–¹æ¡ˆ

#### æ–¹æ¡ˆ Aï¼šåŸºäº Prompt çš„æ¨¡æ‹Ÿå®ç°ï¼ˆæ¨èï¼‰

åœ¨å½“å‰ä¼šè¯ä¸­é€šè¿‡ Prompt åˆ‡æ¢è§’è‰²ï¼Œè€ŒéçœŸæ­£è°ƒç”¨ç‹¬ç«‹çš„ Agentã€‚

```markdown
# å®ç°æ–¹å¼

å½“éœ€è¦è°ƒç”¨æŸä¸ª Agent æ—¶ï¼Œåœ¨ Prompt ä¸­å£°æ˜è§’è‰²åˆ‡æ¢ï¼š

"""
## ğŸ”„ è§’è‰²åˆ‡æ¢

**åˆ‡æ¢åˆ°**: backend-java Agent
**ä»»åŠ¡**: æ‰§è¡Œ Ticket T-003

---

### åŠ è½½é…ç½®
- Agent: .claude/project/agents/backend-java.md
- Skills: deliver-ticket, tdd, checkpoint-manager
- Rules: java.md

### ç³»ç»Ÿæç¤ºè¯
{åŠ è½½ backend-java.md çš„å†…å®¹}

---

å¼€å§‹æ‰§è¡Œä»»åŠ¡...
"""
```

**ä¼˜ç‚¹**ï¼š
- æ— éœ€é¢å¤–å·¥å…·
- åœ¨å½“å‰ Cursor ä¸­å³å¯ä½¿ç”¨
- ä¿æŒä¸Šä¸‹æ–‡è¿ç»­æ€§

**ç¼ºç‚¹**ï¼š
- è§’è‰²åˆ‡æ¢é  Prompt çº¦æŸï¼Œå¯èƒ½ä¸å¤Ÿä¸¥æ ¼
- æ— æ³•çœŸæ­£å¹¶è¡Œæ‰§è¡Œ

#### æ–¹æ¡ˆ Bï¼šä½¿ç”¨ Claude Code CLIï¼ˆæœªæ¥ï¼‰

å¦‚æœä½¿ç”¨ Claude Code CLIï¼Œå¯ä»¥çœŸæ­£è°ƒç”¨ Subagentï¼š

```bash
# Claude Code å®˜æ–¹ subagent è¯­æ³•
claude --agent backend-java --prompt "æ‰§è¡Œ Ticket T-003"
```

#### æ–¹æ¡ˆ Cï¼šä½¿ç”¨ MCP å·¥å…·ï¼ˆé«˜çº§ï¼‰

é€šè¿‡ MCP (Model Context Protocol) å®ç°çœŸæ­£çš„ Agent åˆ†æ´¾ï¼š

```typescript
// MCP Server ç¤ºä¾‹
const dispatchAgent = async (agentName: string, prompt: string) => {
  const agentConfig = loadAgent(agentName);
  const skills = loadSkills(agentConfig.skills);
  
  return await claude.chat({
    system: agentConfig.systemPrompt + skills.join('\n'),
    messages: [{ role: 'user', content: prompt }]
  });
};
```

### å½“å‰æ¨èå®ç°

åœ¨ Cursor ä¸­ä½¿ç”¨**æ–¹æ¡ˆ A**ï¼Œé€šè¿‡ä»¥ä¸‹æ–¹å¼æ¨¡æ‹Ÿ Agent è°ƒç”¨ï¼š

```markdown
# /next å‘½ä»¤çš„å®é™…æ‰§è¡Œ

1. è¯»å– STATE.yamlï¼Œè·å–ä¸‹ä¸€ä¸ª Ticket
2. è¯»å– Ticket çš„ type å­—æ®µ
3. æ ¹æ® type ç¡®å®š Agent åç§°
4. è¯»å– Agent é…ç½®æ–‡ä»¶
5. åœ¨å½“å‰ä¼šè¯ä¸­"æ‰®æ¼”"è¯¥ Agent
6. æ‰§è¡Œ deliver-ticket skill

## ç¤ºä¾‹æ‰§è¡Œæµç¨‹

ç”¨æˆ·: /next

AI å“åº”:
"""
## ğŸ”„ ä»»åŠ¡åˆ†æ´¾

**ä¸‹ä¸€ä¸ª Ticket**: T-003 - ç”¨æˆ·ç¼–è¾‘ API
**ç±»å‹**: backend
**åˆ†æ´¾ç»™**: backend-java

---

## ğŸ“‹ [backend-java Agent] ä»»åŠ¡ç†è§£

**Ticket**: T-003 - ç”¨æˆ·ç¼–è¾‘ API
...
"""
```

---

## 2. ä¸Šä¸‹æ–‡ä½¿ç”¨ç‡æ£€æµ‹

### é—®é¢˜èƒŒæ™¯

æ¡†æ¶è®¾è®¡ä¸­éœ€è¦æ£€æµ‹ `context_usage` ç™¾åˆ†æ¯”ï¼Œä»¥ä¾¿åœ¨æ¥è¿‘é™åˆ¶æ—¶è§¦å‘å‹ç¼©ã€‚ä½†æˆ‘ä»¬æ— æ³•ç›´æ¥è·å– Claude çš„ token ä½¿ç”¨é‡ã€‚

### è§£å†³æ–¹æ¡ˆ

#### æ–¹æ¡ˆ Aï¼šåŸºäºæ–‡ä»¶å¤§å°ä¼°ç®—ï¼ˆæ¨èï¼‰

```python
# ä¼°ç®—ä¸Šä¸‹æ–‡ä½¿ç”¨ç‡
def estimate_context_usage():
    # 1. è®¡ç®—å·²åŠ è½½çš„æ–‡ä»¶æ€»å¤§å°
    loaded_files_size = sum(
        os.path.getsize(f) for f in loaded_files
    )
    
    # 2. ä¼°ç®—å¯¹è¯å†å²å¤§å°
    conversation_size = len(conversation_history) * AVG_CHARS_PER_MESSAGE
    
    # 3. ä¼°ç®—æ€» token æ•°ï¼ˆçº¦ 4 å­—ç¬¦ = 1 tokenï¼‰
    estimated_tokens = (loaded_files_size + conversation_size) / 4
    
    # 4. Claude ä¸Šä¸‹æ–‡çª—å£çº¦ 200K tokens
    MAX_TOKENS = 200000
    
    return (estimated_tokens / MAX_TOKENS) * 100
```

#### æ–¹æ¡ˆ Bï¼šåŸºäºæ¶ˆæ¯è½®æ¬¡ä¼°ç®—

```yaml
# ç®€åŒ–ä¼°ç®—è§„åˆ™
estimation_rules:
  # æ¯è½®å¯¹è¯çº¦æ¶ˆè€— 2000-5000 tokens
  per_round_tokens: 3000
  
  # æ¯ä¸ªåŠ è½½çš„æ–‡ä»¶
  per_file_tokens: 500  # å¹³å‡
  
  # é˜ˆå€¼
  warning_threshold: 70%   # æç¤ºå³å°†å‹ç¼©
  compress_threshold: 85%  # è‡ªåŠ¨è§¦å‘å‹ç¼©
```

#### æ–¹æ¡ˆ Cï¼šåŸºäºè¡Œä¸ºè§‚å¯Ÿ

å½“ Claude å¼€å§‹ï¼š
- å¿˜è®°ä¹‹å‰çš„å¯¹è¯å†…å®¹
- é‡å¤è¯¢é—®å·²å›ç­”çš„é—®é¢˜
- å“åº”å˜æ…¢

è¿™äº›ä¿¡å·è¡¨æ˜ä¸Šä¸‹æ–‡å¯èƒ½æ¥è¿‘é¥±å’Œã€‚

### å½“å‰æ¨èå®ç°

```yaml
# memory/session.yaml ä¸­è®°å½•
context_tracking:
  # è®°å½•åŠ è½½çš„æ–‡ä»¶
  loaded_files:
    - path: "tasks/STATE.yaml"
      size: 2048
      tokens_est: 512
    - path: "tasks/tickets/T-003.yaml"
      size: 4096
      tokens_est: 1024
      
  # è®°å½•å¯¹è¯è½®æ¬¡
  conversation_rounds: 15
  
  # ä¼°ç®—
  estimated_tokens: 50000
  estimated_usage_percent: 25
  
  # è§¦å‘ç‚¹
  last_warning_at: null
  last_compression_at: null
```

---

## 3. æ£€æŸ¥ç‚¹ä¸ Git é›†æˆ

### è‡ªåŠ¨ Git Commit

```yaml
# project/config.yaml ä¸­é…ç½®
git_integration:
  enabled: true
  auto_commit: true
  commit_on:
    - ticket_completed      # Ticket å®Œæˆæ—¶
    - checkpoint_created    # åˆ›å»ºæ£€æŸ¥ç‚¹æ—¶
  
  commit_message_template: |
    [{ticket_id}] {ticket_title}
    
    Story: {story_id}
    Agent: {agent}
    
    Files changed:
    {files_list}
```

### å®ç°é€»è¾‘

```python
def create_checkpoint_with_git(checkpoint_data):
    # 1. åˆ›å»ºæ£€æŸ¥ç‚¹æ–‡ä»¶
    checkpoint_file = f"checkpoints/{checkpoint_data['id']}.yaml"
    save_yaml(checkpoint_file, checkpoint_data)
    
    # 2. Git æ“ä½œ
    if config.git_integration.enabled:
        # æš‚å­˜æ‰€æœ‰å˜æ›´
        run_command("git add -A")
        
        # åˆ›å»º commit
        message = format_commit_message(checkpoint_data)
        run_command(f'git commit -m "{message}"')
        
        # è®°å½• commit hash
        commit_hash = run_command("git rev-parse HEAD")
        checkpoint_data['git']['commit'] = commit_hash
        
        # æ›´æ–°æ£€æŸ¥ç‚¹æ–‡ä»¶
        save_yaml(checkpoint_file, checkpoint_data)
    
    return checkpoint_data
```

### å›æ»šå®ç°

```python
def rollback_to_checkpoint(checkpoint_id):
    # 1. è¯»å–æ£€æŸ¥ç‚¹
    checkpoint = load_yaml(f"checkpoints/{checkpoint_id}.yaml")
    
    # 2. Git reset
    if checkpoint.get('git', {}).get('commit'):
        run_command(f"git reset --hard {checkpoint['git']['commit']}")
    
    # 3. æ¢å¤ STATE.yaml
    state = {
        'phase': checkpoint['state']['phase'],
        'current': {
            'story': checkpoint['state']['story'],
            'ticket': checkpoint['state']['ticket'],
        },
        # ... å…¶ä»–çŠ¶æ€
    }
    save_yaml("tasks/STATE.yaml", state)
    
    return checkpoint
```

---

## 4. å‰ç«¯æµ‹è¯•ç­–ç•¥

### é—®é¢˜èƒŒæ™¯

`frontend-vue` Agent æ²¡æœ‰åŠ è½½ `tdd` skillï¼Œå› ä¸ºå‰ç«¯æµ‹è¯•ç­–ç•¥ä¸åç«¯ä¸åŒã€‚

### å‰ç«¯æµ‹è¯•æ–¹æ¡ˆ

```yaml
# å‰ç«¯æµ‹è¯•ç­–ç•¥
frontend_testing:
  # å•å…ƒæµ‹è¯•ï¼ˆå¯é€‰ï¼‰
  unit_tests:
    enabled: false  # Vue 2 é¡¹ç›®å¯èƒ½æ²¡æœ‰é…ç½®
    tool: "jest"
    command: "npm run test:unit"
    
  # Lint æ£€æŸ¥ï¼ˆå¿…é¡»ï¼‰
  lint:
    enabled: true
    command: "npm run lint"
    auto_fix: true
    
  # æ„å»ºæ£€æŸ¥ï¼ˆå¿…é¡»ï¼‰
  build:
    enabled: true
    command: "npm run build"
    
  # è§†è§‰éªŒè¯ï¼ˆå¯é€‰ï¼‰
  visual:
    enabled: false  # éœ€è¦é…ç½® Storybook æˆ–ç±»ä¼¼å·¥å…·
```

### å‰ç«¯ Ticket éªŒæ”¶æ ‡å‡†

```yaml
# å‰ç«¯ Ticket ç¤ºä¾‹
id: T-005
type: frontend
agent: frontend-vue

acceptance:
  # å¿…é¡»é€šè¿‡ lint
  - type: command
    run: "npm run lint"
    expect: "No ESLint errors"
    
  # å¿…é¡»èƒ½æ„å»º
  - type: command
    run: "npm run build"
    expect: "Build complete"
    
  # å¯é€‰ï¼šæˆªå›¾éªŒè¯
  - type: manual
    description: "é¡µé¢æ­£å¸¸æ˜¾ç¤ºï¼ŒåŠŸèƒ½å¯ç”¨"
```

---

## 5. ä¼šè¯æ¢å¤å®ç°

### æ¢å¤æµç¨‹

```python
def restore_session():
    # 1. è¯»å–é…ç½®
    config = load_yaml(".claude/project/config.yaml")
    
    # 2. è¯»å–çŠ¶æ€
    state = load_yaml("tasks/STATE.yaml")
    
    # 3. è¯»å–è®°å¿†
    session = load_yaml(".claude/memory/session.yaml")
    decisions = load_yaml(".claude/memory/decisions.yaml")
    
    # 4. åŠ è½½æœ€è¿‘æ‘˜è¦ï¼ˆå¦‚æœ‰ï¼‰
    summaries_dir = ".claude/memory/summaries/"
    latest_summary = get_latest_file(summaries_dir)
    if latest_summary:
        summary_content = read_file(latest_summary)
    
    # 5. ç”Ÿæˆæ¢å¤æŠ¥å‘Š
    report = generate_restore_report(state, session, decisions, summary_content)
    
    return report
```

### æ¢å¤æŠ¥å‘Šæ¨¡æ¿

```markdown
## ğŸ”„ ä¼šè¯æ¢å¤

**ä¸Šæ¬¡ä¼šè¯**: {session.last_active}
**å½“å‰é˜¶æ®µ**: {state.phase}
**å½“å‰ä»»åŠ¡**: {state.current.story} / {state.current.ticket}

### è¿›åº¦
- Story {story_id}: {story_title} ({progress})
- ä¸‹ä¸€ä¸ª Ticket: {next_ticket_id} - {next_ticket_title}

### é‡è¦å†³ç­–
{decisions_list}

### å†å²æ‘˜è¦
{summary_content}

### å¯ç”¨æ“ä½œ
- `/next` - ç»§ç»­æ‰§è¡Œ {next_ticket_id}
- `/status` - æŸ¥çœ‹è¯¦ç»†çŠ¶æ€
- `/restore CP-xxx` - æ¢å¤åˆ°æŒ‡å®šæ£€æŸ¥ç‚¹

---
ç»§ç»­æ‰§è¡Œ {next_ticket_id} å—ï¼Ÿè¾“å…¥ `/next` æˆ–å…¶ä»–å‘½ä»¤ã€‚
```

---

## 6. é”™è¯¯å¤„ç†å®ç°

### æµ‹è¯•å¤±è´¥è‡ªåŠ¨ä¿®å¤

```python
def handle_test_failure(ticket, failure_info, attempt):
    MAX_RETRIES = 3
    
    if attempt >= MAX_RETRIES:
        return {
            'action': 'stop',
            'reason': 'max_retries_reached',
            'message': f'æµ‹è¯•å¤±è´¥ï¼Œå·²é‡è¯• {MAX_RETRIES} æ¬¡'
        }
    
    # è°ƒç”¨ debugging skill åˆ†æ
    analysis = invoke_skill('debugging', {
        'error': failure_info,
        'files': ticket['allowed_paths']['modify']
    })
    
    # å°è¯•è‡ªåŠ¨ä¿®å¤
    if analysis.get('auto_fixable'):
        apply_fix(analysis['fix'])
        return {
            'action': 'retry',
            'reason': 'auto_fixed',
            'fix_applied': analysis['fix']
        }
    else:
        return {
            'action': 'stop',
            'reason': 'need_human_intervention',
            'analysis': analysis
        }
```

### è·¯å¾„è¿è§„æ£€æµ‹

```python
def check_path_violation(modified_files, allowed_paths):
    violations = []
    
    for file_path in modified_files:
        allowed = False
        for pattern in allowed_paths['modify']:
            if fnmatch(file_path, pattern):
                allowed = True
                break
        
        if not allowed:
            violations.append(file_path)
    
    if violations:
        return {
            'violation': True,
            'files': violations,
            'action': 'stop_and_rollback'
        }
    
    return {'violation': False}
```

---

## 7. /init-project å‘½ä»¤å®ç°

### å®ç°è„šæœ¬

```bash
#!/bin/bash
# init-project.sh

PROJECT_NAME=$1
STACK=$2  # æ ¼å¼: java,vue,mysql

# è§£ææŠ€æœ¯æ ˆ
IFS=',' read -ra TECHS <<< "$STACK"

# 1. åˆ›å»ºç›®å½•ç»“æ„
mkdir -p .claude/core/skills
mkdir -p .claude/core/agents
mkdir -p .claude/core/templates
mkdir -p .claude/project/agents
mkdir -p .claude/project/rules
mkdir -p .claude/memory/summaries
mkdir -p .claude/checkpoints
mkdir -p .claude/commands
mkdir -p docs/requirements
mkdir -p tasks/stories
mkdir -p tasks/tickets
mkdir -p workspace/logs
mkdir -p artifacts/reviews

# 2. å¤åˆ¶æ ¸å¿ƒæ¡†æ¶ï¼ˆå‡è®¾æœ‰æ¨¡æ¿ç›®å½•ï¼‰
cp -r /path/to/core-template/.claude/core/* .claude/core/

# 3. ç”Ÿæˆé¡¹ç›®é…ç½®
cat > .claude/project/config.yaml << EOF
name: $PROJECT_NAME
type: fullstack

tech_stack:
$(for tech in "${TECHS[@]}"; do
  case $tech in
    java) echo "  backend:
    language: java
    framework: spring-boot" ;;
    vue) echo "  frontend:
    language: javascript
    framework: vue" ;;
    mysql) echo "  database:
    type: mysql" ;;
  esac
done)

commands:
  test: "mvn -q test"
  build: "mvn -q -DskipTests package"
  lint: "mvn checkstyle:check"

developers:
$(for tech in "${TECHS[@]}"; do
  case $tech in
    java) echo "  - backend-java" ;;
    vue) echo "  - frontend-vue" ;;
    mysql) echo "  - dba-mysql" ;;
  esac
done)

approval:
  story_split: required
  ticket_split: required
  ticket_done: auto
  story_done: required

memory:
  compression_threshold: 70%
  checkpoint_interval: per_ticket
EOF

# 4. åˆå§‹åŒ– STATE.yaml
cat > tasks/STATE.yaml << EOF
version: "1.0"
last_updated: "$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
phase: research
current:
  requirement: null
  story: null
  ticket: null
  agent: null
requirements: []
stories: {}
stats:
  total_requirements: 0
  completed_requirements: 0
  total_stories: 0
  completed_stories: 0
  total_tickets: 0
  completed_tickets: 0
  failed_tickets: 0
  blocked_tickets: 0
checkpoints:
  last: null
  count: 0
context:
  usage_percent: 0
  last_compression: null
  compression_count: 0
session:
  id: ""
  started_at: ""
  last_active: ""
approvals:
  stories_approved: false
  tickets_approved: false
config:
  project: .claude/project/config.yaml
  loaded_at: ""
EOF

# 5. åˆ›å»º CLAUDE.md
cat > .claude/CLAUDE.md << EOF
# ä¸€äººå…¬å¸ AI äº¤ä»˜æ¡†æ¶

## é¡¹ç›®: $PROJECT_NAME

## åŠ è½½é…ç½®
- æ ¸å¿ƒæ¡†æ¶: .claude/core/
- é¡¹ç›®é…ç½®: .claude/project/config.yaml
- å½“å‰çŠ¶æ€: tasks/STATE.yaml

## å¯ç”¨å‘½ä»¤
| å‘½ä»¤ | è¯´æ˜ |
|------|------|
| /brainstorm | å¤´è„‘é£æš´ï¼Œç»†åŒ–éœ€æ±‚ |
| /split story | å°†éœ€æ±‚æ‹†è§£ä¸º Story |
| /split ticket S-xxx | å°† Story æ‹†è§£ä¸º Ticket |
| /approve | å®¡æ‰¹æ‹†è§£ç»“æœ |
| /next | æ‰§è¡Œä¸‹ä¸€ä¸ª Ticket |
| /status | æŸ¥çœ‹å½“å‰è¿›åº¦ |
| /checkpoint | ä¿å­˜æ£€æŸ¥ç‚¹ |
| /restore | æ¢å¤æ£€æŸ¥ç‚¹ |
| /rollback | å›æ»šå˜æ›´ |

## å¼€å§‹ä½¿ç”¨
1. å°†éœ€æ±‚æ”¾åˆ° docs/requirements/REQ-001.md
2. è¿è¡Œ /brainstorm ç»†åŒ–éœ€æ±‚
3. è¿è¡Œ /split story æ‹†è§£ Stories
4. è¿è¡Œ /approve stories å®¡æ‰¹
5. è¿è¡Œ /split ticket S-001 æ‹†è§£ Tickets
6. è¿è¡Œ /approve tickets å®¡æ‰¹
7. è¿è¡Œ /next å¼€å§‹æ‰§è¡Œ
EOF

echo "âœ… é¡¹ç›®åˆå§‹åŒ–å®Œæˆ: $PROJECT_NAME"
echo "ä¸‹ä¸€æ­¥: å°†éœ€æ±‚æ”¾åˆ° docs/requirements/REQ-001.md"
```

---

## 8. éœ€æ±‚è¯†åˆ«ä¸æ³¨å†Œæœºåˆ¶

### é—®é¢˜èƒŒæ™¯

æ¡†æ¶è¦æ±‚ç”¨æˆ·å°†éœ€æ±‚æ”¾åˆ° `docs/requirements/REQ-xxx.md`ï¼Œä½†æ¡†æ¶å¦‚ä½•çŸ¥é“æœ‰æ–°éœ€æ±‚ï¼ŸSTATE.yaml ä¸­çš„ `requirements` å­—æ®µå¦‚ä½•æ›´æ–°ï¼Ÿ

### è§£å†³æ–¹æ¡ˆ

#### æ–¹æ¡ˆ Aï¼šæ‰‹åŠ¨æ³¨å†Œï¼ˆæ¨èï¼‰

ç”¨æˆ·æ˜ç¡®å‘ŠçŸ¥æ¡†æ¶è¦å¤„ç†å“ªä¸ªéœ€æ±‚ã€‚

```bash
# æ–¹å¼ 1ï¼šç›´æ¥æŒ‡å®šéœ€æ±‚
/brainstorm REQ-001

# æ–¹å¼ 2ï¼šæ³¨å†Œå‘½ä»¤
/add-requirement docs/requirements/REQ-001.md
```

**æ³¨å†Œæµç¨‹**ï¼š
```python
def add_requirement(req_path):
    # 1. éªŒè¯æ–‡ä»¶å­˜åœ¨
    if not os.path.exists(req_path):
        return error("éœ€æ±‚æ–‡ä»¶ä¸å­˜åœ¨")
    
    # 2. è§£æéœ€æ±‚ ID
    req_id = extract_req_id(req_path)  # ä»æ–‡ä»¶åæˆ–å†…å®¹æå–
    
    # 3. æ›´æ–° STATE.yaml
    state = load_yaml("tasks/STATE.yaml")
    state['requirements'].append({
        'id': req_id,
        'path': req_path,
        'status': 'pending',
        'added_at': datetime.now().isoformat()
    })
    state['current']['requirement'] = req_id
    save_yaml("tasks/STATE.yaml", state)
    
    return success(f"éœ€æ±‚ {req_id} å·²æ³¨å†Œ")
```

**è¾“å‡ºç¤ºä¾‹**ï¼š
```
## âœ… éœ€æ±‚å·²æ³¨å†Œ

- **ID**: REQ-001
- **è·¯å¾„**: docs/requirements/REQ-001.md
- **çŠ¶æ€**: pending

**ä¸‹ä¸€æ­¥**: è¿è¡Œ `/brainstorm` ç»†åŒ–éœ€æ±‚
```

#### æ–¹æ¡ˆ Bï¼šè‡ªåŠ¨æ‰«æ

åœ¨ `/brainstorm` æˆ– `/split story` æ‰§è¡Œæ—¶è‡ªåŠ¨æ‰«æ `docs/requirements/` ç›®å½•ã€‚

```python
def auto_scan_requirements():
    req_dir = "docs/requirements/"
    state = load_yaml("tasks/STATE.yaml")
    existing_ids = [r['id'] for r in state.get('requirements', [])]
    
    new_reqs = []
    for file in glob.glob(f"{req_dir}REQ-*.md"):
        req_id = extract_req_id(file)
        if req_id not in existing_ids:
            new_reqs.append({
                'id': req_id,
                'path': file,
                'status': 'pending',
                'added_at': datetime.now().isoformat()
            })
    
    if new_reqs:
        state['requirements'].extend(new_reqs)
        save_yaml("tasks/STATE.yaml", state)
        return new_reqs
    
    return []
```

**è‡ªåŠ¨æ‰«æè§¦å‘æ—¶æœº**ï¼š
- `/brainstorm`ï¼ˆæ— å‚æ•°æ—¶ï¼‰
- `/split story`ï¼ˆæ— å‚æ•°æ—¶ï¼‰
- `/status`ï¼ˆæ˜¾ç¤ºæ–°å‘ç°çš„éœ€æ±‚ï¼‰

**è¾“å‡ºç¤ºä¾‹**ï¼š
```
## ğŸ“‹ å‘ç°æ–°éœ€æ±‚

| ID | è·¯å¾„ | å‘ç°æ—¶é—´ |
|----|------|----------|
| REQ-001 | docs/requirements/REQ-001.md | åˆšåˆš |
| REQ-002 | docs/requirements/REQ-002.md | åˆšåˆš |

**ä¸‹ä¸€æ­¥**:
- å¤„ç† REQ-001: `/brainstorm REQ-001`
- æŸ¥çœ‹æ‰€æœ‰éœ€æ±‚: `/status --requirements`
```

### æ¨èåšæ³•

1. **é¦–æ¬¡ä½¿ç”¨**ï¼šæ‰‹åŠ¨æŒ‡å®š `/brainstorm REQ-001`
2. **åç»­éœ€æ±‚**ï¼šæ”¾å…¥ `docs/requirements/` åè¿è¡Œ `/status` ä¼šæç¤ºå‘ç°æ–°éœ€æ±‚
3. **æ‰¹é‡å¤„ç†**ï¼šä½¿ç”¨ `/brainstorm --all` ä¾æ¬¡å¤„ç†æ‰€æœ‰ pending éœ€æ±‚

### éœ€æ±‚å‘½åè§„èŒƒ

```
docs/requirements/
â”œâ”€â”€ REQ-001.md           # æ ¼å¼: REQ-{åºå·}.md
â”œâ”€â”€ REQ-002-user-module.md   # å¯é€‰: REQ-{åºå·}-{ç®€è¿°}.md
â””â”€â”€ REQ-003.md
```

æ–‡ä»¶å†…å®¹é¦–è¡Œåº”åŒ…å«éœ€æ±‚ IDï¼š
```markdown
# REQ-001: ç”¨æˆ·ç®¡ç†æ¨¡å—

## èƒŒæ™¯
...
```

---

## 9. å¤š Story æ‰§è¡Œç­–ç•¥

### é—®é¢˜èƒŒæ™¯

å½“æœ‰å¤šä¸ª Storyï¼ˆS-001, S-002ï¼‰æ—¶ï¼Œ`/next` å‘½ä»¤æŒ‰ä»€ä¹ˆé¡ºåºæ‰§è¡Œ Ticketsï¼Ÿ

### è§£å†³æ–¹æ¡ˆ

åœ¨ `project/config.yaml` ä¸­é…ç½®æ‰§è¡Œç­–ç•¥ï¼š

```yaml
# project/config.yaml
execution:
  # æ‰§è¡Œæ¨¡å¼
  mode: sequential  # sequential | parallel | priority
  
  # sequential æ¨¡å¼ï¼ˆé»˜è®¤ï¼‰
  # å®Œæˆ S-001 æ‰€æœ‰ Tickets åï¼Œå†æ‰§è¡Œ S-002
  sequential:
    order: "by_priority"  # by_priority | by_id | by_dependency
  
  # parallel æ¨¡å¼ï¼ˆéœ€è¦ Git Worktreeï¼‰
  # å¤šä¸ª Story å¯ä»¥å¹¶è¡Œæ‰§è¡Œ
  parallel:
    max_parallel_stories: 2
    isolation: "worktree"  # worktree | branch
  
  # priority æ¨¡å¼
  # æŒ‰ Ticket ä¼˜å…ˆçº§è·¨ Story æ‰§è¡Œ
  priority:
    p0_first: true
    same_priority_order: "by_story"  # by_story | by_id
```

### æ‰§è¡Œç­–ç•¥è¯¦è§£

#### 1. Sequentialï¼ˆé¡ºåºæ¨¡å¼ï¼‰- é»˜è®¤

```
S-001: T-001 â†’ T-002 â†’ T-003 â†’ å®Œæˆ
S-002: T-004 â†’ T-005 â†’ å®Œæˆ
```

**ä¼˜ç‚¹**ï¼šç®€å•ï¼Œæ— å†²çª
**ç¼ºç‚¹**ï¼šæ•ˆç‡ä½ï¼Œæ— æ³•å¹¶è¡Œ

#### 2. Parallelï¼ˆå¹¶è¡Œæ¨¡å¼ï¼‰

```
Worktree-1 (S-001): T-001 â†’ T-002 â†’ T-003
Worktree-2 (S-002): T-004 â†’ T-005
```

**ä¼˜ç‚¹**ï¼šæ•ˆç‡é«˜
**ç¼ºç‚¹**ï¼šå¤æ‚ï¼Œéœ€è¦ Git Worktree

#### 3. Priorityï¼ˆä¼˜å…ˆçº§æ¨¡å¼ï¼‰

```
P0: T-001 (S-001), T-004 (S-002)
P1: T-002 (S-001), T-005 (S-002)
P2: T-003 (S-001)
```

**ä¼˜ç‚¹**ï¼šå…³é”®åŠŸèƒ½å…ˆå®Œæˆ
**ç¼ºç‚¹**ï¼šStory å®Œæ•´æ€§è¾ƒå·®

### /next å‘½ä»¤çš„é€‰æ‹©é€»è¾‘

```python
def get_next_ticket(config):
    mode = config.get('execution', {}).get('mode', 'sequential')
    
    if mode == 'sequential':
        # æ‰¾åˆ°ç¬¬ä¸€ä¸ªæœªå®Œæˆçš„ Storyï¼Œæ‰§è¡Œå…¶ pending Ticket
        for story in get_stories_by_order():
            if story.status != 'completed':
                for ticket in story.tickets:
                    if ticket.status == 'pending':
                        return ticket
                        
    elif mode == 'priority':
        # æ‰¾åˆ°æœ€é«˜ä¼˜å…ˆçº§çš„ pending Ticket
        return get_highest_priority_pending_ticket()
        
    elif mode == 'parallel':
        # è¿”å›å½“å‰ worktree å¯¹åº” Story çš„ pending Ticket
        current_story = get_current_worktree_story()
        return get_pending_ticket(current_story)
    
    return None
```

### æ¨èé…ç½®ï¼ˆè‹¥ä¾é¡¹ç›®ï¼‰

```yaml
# è‹¥ä¾é¡¹ç›®æ¨èï¼šé¡ºåºæ¨¡å¼
execution:
  mode: sequential
  sequential:
    order: by_priority  # P0 Story å…ˆæ‰§è¡Œ
```

---

## ç›¸å…³æ–‡æ¡£

- [00_æ¦‚è§ˆ](00_æ¦‚è§ˆ.md) - è¿”å›æ¦‚è§ˆ
- [40_commands_å‘½ä»¤æ–‡ä»¶](40_commands_å‘½ä»¤æ–‡ä»¶.md) - å‘½ä»¤æ–‡ä»¶è¯¦æƒ…
- [41_templates_æ¨¡æ¿æ–‡ä»¶](41_templates_æ¨¡æ¿æ–‡ä»¶.md) - æ¨¡æ¿æ–‡ä»¶è¯¦æƒ…
